<% layout = typeof layout !== 'undefined' ? layout : 'layout' %>
<div class="profile-page">
  <div class="profile-hero" style="background:#f59d9d; height:180px; display:block;"></div>
  <div class="profile-inner" style="max-width:900px; margin: -60px auto 2rem; padding: 1rem;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
      <div style="display:flex; align-items:center; gap:1rem;">
        <div class="avatar" style="width:120px; height:120px; border-radius:999px; overflow:hidden; border:4px solid #000; background:#eee;">
          <% if (user && user.profilePhoto) { %>
            <img src="<%= user.profilePhoto %>" alt="avatar" style="width:100%; height:100%; object-fit:cover; display:block;" />
          <% } else { %>
            <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#777; font-size:2rem;">‚àò</div>
          <% } %>
        </div>
        <div>
          <h2 style="margin:0; font-size:1.5rem;"><%= user.displayName || user.username %> <% if (false) { %><span style="font-size:0.8rem; color:#999;">üîí</span><% } %></h2>
          <div style="color:#777; margin-top:.25rem;">@<%= user.username %></div>

          <% if (user.bio) { %>
            <div style="margin-top:.5rem; color:#666;"><%= user.bio %></div>
          <% } %>

          <% if (user.location) { %>
            <div style="margin-top:.25rem; color:#666; font-size:.95rem; display:flex; align-items:center; gap:.5rem;">
              <span style="font-size:1rem;">üìç</span>
              <span><%= user.location %></span>
            </div>
          <% } %>

          <div style="margin-top:.6rem; color:#666;">
            <strong><%= (user.followingCount !== undefined ? user.followingCount : (user.following && user.following.length) || 0) %></strong> Mengikuti &nbsp;&nbsp;
            <strong><%= (user.followersCount !== undefined ? user.followersCount : (user.followers && user.followers.length) || 0) %></strong> Pengikut
          </div>
        </div>
      </div>

      <div>
        <button id="editBtn" class="btn" style="padding:.5rem 1rem; border-radius:999px; border:1px solid rgba(255,255,255,.08); background:transparent; color:inherit;">Edit profil</button>
      </div>
    </div>

    <div id="editModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:60;">
      <div style="position:relative; max-width:720px; margin:3rem auto; background:var(--bg,#000); color:inherit; border-radius:10px; padding:1.25rem; box-shadow:0 10px 30px rgba(0,0,0,.5);">
        <button id="closeEdit" style="position:absolute; left:12px; top:12px; background:transparent; border:none; color:inherit; font-size:1.25rem;">‚úï</button>
        <button form="editForm" type="submit" style="position:absolute; right:12px; top:12px; padding:.5rem 1rem; border-radius:999px; background:#fff; color:#000; border:none;">Simpan</button>

        <form id="editForm" action="/profile" method="post" enctype="multipart/form-data" style="display:flex; gap:1rem; align-items:flex-start;">
          <div style="width:38%; display:flex; flex-direction:column; align-items:center; gap:1rem; padding:1rem;">
            <div style="position:relative; width:140px; height:140px; border-radius:999px; overflow:hidden; border:4px solid rgba(255,255,255,.08); background:#222;">
              <% if (user && user.profilePhoto) { %>
                <img id="avatarPreview" src="<%= user.profilePhoto %>" alt="avatar" style="width:100%; height:100%; object-fit:cover; display:block; transform-origin:center center; position:relative;" />
              <% } else { %>
                <div id="avatarPreview" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#777; font-size:2rem;">‚àò</div>
              <% } %>
            </div>
                    <label id="changePhotoBtn" style="display:inline-block; padding:.4rem .6rem; border-radius:6px; border:1px solid #444; cursor:pointer;">Ganti Foto
                      <input id="avatarInput" type="file" name="avatar" accept="image/*" capture="environment" style="display:none;" />
                    </label>
            <div style="width:100%; margin-top:.5rem; display:flex; gap:.5rem; align-items:center;">
              <label style="font-size:.85rem; color:#bbb;">Zoom</label>
              <input id="zoomRange" type="range" min="1" max="3" step="0.01" value="1" style="flex:1;" />
            </div>
          </div>

          <div style="flex:1; padding:1rem;">
            <div style="margin-bottom:1rem;">
              <label style="display:block; font-size:.9rem; color:#bbb; margin-bottom:.4rem;">Username</label>
              <input id="usernameInput" name="username" value="<%= user.username %>" placeholder="username" style="width:100%; padding:.75rem; border-radius:6px; border:1px solid #333; background:transparent; color:inherit;" />
              <div id="usernameMsg" style="margin-top:.4rem; font-size:.85rem; color:#e07; display:none;"></div>
            </div>

            <div style="margin-bottom:1rem;">
              <label style="display:block; font-size:.9rem; color:#bbb; margin-bottom:.4rem;">Nama (display name)</label>
              <input name="displayName" value="<%= user.displayName || '' %>" placeholder="Nama panggilan" style="width:100%; padding:.75rem; border-radius:6px; border:1px solid #333; background:transparent; color:inherit;" />
            </div>

            <div style="margin-bottom:1rem;">
              <label style="display:block; font-size:.9rem; color:#bbb; margin-bottom:.4rem;">Bio</label>
              <textarea name="bio" placeholder="Bio" rows="4" style="width:100%; padding:.75rem; border-radius:6px; border:1px solid #333; background:transparent; color:inherit;"><%= user.bio || '' %></textarea>
            </div>

            <div>
              <label style="display:block; font-size:.9rem; color:#bbb; margin-bottom:.4rem;">Lokasi</label>
              <input name="location" value="<%= user.location || '' %>" placeholder="Lokasi" style="width:100%; padding:.6rem; border-radius:6px; border:1px solid #333; background:transparent; color:inherit;" />
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
    <div id="cropModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:80;">
  <div class="cropModalInner" style="position:relative; max-width:520px; width:90vw; height:520px; margin:2rem auto; background:transparent; color:inherit; border-radius:10px;">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 18px;">
          <button id="cropBack" style="background:transparent; border:none; color:#fff; font-size:1.2rem;">‚Üê</button>
          <div style="color:#fff; font-weight:600;">Edit media</div>
          <button id="cropApply" style="padding:.5rem 1rem; border-radius:999px; background:#fff; color:#000; border:none;">Terapkan</button>
        </div>
        <div style="display:flex; justify-content:center; align-items:center; height:calc(100% - 84px);">
          <div style="position:relative; width:100%; max-width:520px; height:100%; display:flex; align-items:center; justify-content:center;">
            <div style="position:relative; width:100%; max-width:360px; height:100%; max-height:360px; display:flex; align-items:center; justify-content:center;">
              <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">
                <div id="cropContainer" style="width:320px; height:320px; max-width:86vw; max-height:86vw; background:transparent; overflow:hidden; border-radius:4px;">
                  <img id="cropImage" src="" style="width:100%; height:100%; object-fit:cover; display:block;" />
                </div>
              </div>
            </div>
          </div>
        </div>
        <div style="position:absolute; left:0; right:0; bottom:12px; display:flex; align-items:center; justify-content:center; gap:12px;">
          <button id="zoomOut" style="background:transparent; border:none; color:#fff; font-size:1.25rem;">‚àí</button>
          <input id="cropZoomRange" type="range" min="1" max="3" step="0.01" value="1" style="width:360px;" />
          <button id="zoomIn" style="background:transparent; border:none; color:#fff; font-size:1.25rem;">+</button>
        </div>
      </div>
    </div>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <style>
      .cropper-modal { background-color: rgba(0,0,0,0.8) !important; }
      .cropper-view-box, .cropper-crop-box { border: 3px solid #0099FF !important; }
      .cropper-point { background: #0099FF !important; border-color: #0099FF !important; }
      .cropper-point.point-se, .cropper-point.point-nw, .cropper-point.point-sw, .cropper-point.point-ne { width:12px; height:12px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>


<script>
  const editBtn = document.getElementById('editBtn');
  const editModal = document.getElementById('editModal');
  const closeEdit = document.getElementById('closeEdit');
  const avatarInput = document.getElementById('avatarInput');
  const avatarPreview = document.getElementById('avatarPreview');
  const zoomRange = document.getElementById('zoomRange');
  const usernameInput = document.getElementById('usernameInput');
  const usernameMsg = document.getElementById('usernameMsg');

  function openModal(){ editModal.style.display = 'block'; document.body.style.overflow='hidden'; }
  function closeModal(){ editModal.style.display = 'none'; document.body.style.overflow='auto'; }
  if (editBtn) editBtn.addEventListener('click', openModal);
  if (closeEdit) closeEdit.addEventListener('click', closeModal);
  if (editModal) editModal.addEventListener('click', function(e){ if (e.target === editModal) closeModal(); });

  let usernameTimer = null;
  const usernameRegex = /^[a-zA-Z0-9_]{3,30}$/;
  const originalUsername = "<%= user.username %>";
  function showUsernameMessage(msg, ok){ usernameMsg.style.display = 'block'; usernameMsg.style.color = ok ? '#0a0' : '#e07'; usernameMsg.textContent = msg; }
  function hideUsernameMessage(){ usernameMsg.style.display = 'none'; usernameMsg.textContent = ''; }
  usernameInput.addEventListener('input', function(){
    const v = usernameInput.value.trim();
    hideUsernameMessage();
    if (!v) return;
    if (!usernameRegex.test(v)){
      showUsernameMessage('Username harus 3-30 karakter; huruf, angka, atau underscore saja.', false);
      return;
    }
    if (v === originalUsername){ showUsernameMessage('Username tersedia (ini username Anda saat ini).', true); return; }
    if (usernameTimer) clearTimeout(usernameTimer);
    usernameTimer = setTimeout(async ()=>{
      try{
        let res = await fetch('/auth/check-username?username=' + encodeURIComponent(v));
        if (res.status === 404) {
          res = await fetch('/check-username?username=' + encodeURIComponent(v));
        }
        if (!res.ok) { showUsernameMessage('Gagal memeriksa username', false); return; }
        const data = await res.json();
        if (data.available) showUsernameMessage('Username tersedia', true); else showUsernameMessage('Username sudah terpakai', false);
      }catch(err){ showUsernameMessage('Gagal memeriksa username', false); }
    }, 400);
  });

  let imgState = { sx:0, sy:0, scale:1, imgW:0, imgH:0 };
  let isDragging = false; let dragStart = {x:0,y:0};
  function setPreviewTransform(){ if(!avatarPreview || !avatarPreview.style) return; avatarPreview.style.transform = `translate(${imgState.sx}px, ${imgState.sy}px) scale(${imgState.scale})`; }
  zoomRange.addEventListener('input', function(){ imgState.scale = parseFloat(zoomRange.value); setPreviewTransform(); });
  avatarPreview.addEventListener('mousedown', function(e){ isDragging=true; dragStart={x:e.clientX, y:e.clientY}; e.preventDefault(); });
  window.addEventListener('mousemove', function(e){ if(!isDragging) return; const dx = e.clientX - dragStart.x; const dy = e.clientY - dragStart.y; dragStart={x:e.clientX,y:e.clientY}; imgState.sx += dx; imgState.sy += dy; setPreviewTransform(); });
  window.addEventListener('mouseup', function(){ isDragging=false; });

  const cropModal = document.getElementById('cropModal');
  const cropImage = document.getElementById('cropImage');
  const cropApply = document.getElementById('cropApply');
  const cropBack = document.getElementById('cropBack');
  const cropZoomRange = document.getElementById('cropZoomRange');
  const zoomIn = document.getElementById('zoomIn');
  const zoomOut = document.getElementById('zoomOut');
  let cropper = null;
  let currentObjectUrl = null;

  const changePhotoBtn = document.getElementById('changePhotoBtn');
  if (changePhotoBtn) changePhotoBtn.addEventListener('click', function(){ avatarInput.click(); });

  avatarInput.addEventListener('change', function(e){
    const f = avatarInput.files && avatarInput.files[0];
    if (!f) return;
    if (currentObjectUrl) { try{ URL.revokeObjectURL(currentObjectUrl); }catch(e){} }
    currentObjectUrl = URL.createObjectURL(f);
    cropImage.src = currentObjectUrl;
    cropModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    cropImage.onload = function(){
      try{ if (cropper) { cropper.destroy(); cropper = null; } }catch(e){}
      cropper = new Cropper(cropImage, {
        aspectRatio: 1,
        viewMode: 1,
        background: false,
        autoCropArea: 1,
        movable: true,
        zoomable: true,
        responsive: true,
        rotatable: false,
        dragMode: 'move',
        guides: false,
        highlight: false,
        cropBoxResizable: true,
        cropBoxMovable: true,
        ready() { cropZoomRange.value = 1; }
      });
    };
  });

  cropBack.addEventListener('click', function(){
    if (cropper) { try{ cropper.destroy(); }catch(e){} cropper = null; }
    if (currentObjectUrl) { try{ URL.revokeObjectURL(currentObjectUrl); }catch(e){} currentObjectUrl = null; }
    cropModal.style.display = 'none'; document.body.style.overflow = 'auto';
    avatarInput.value = '';
  });

  cropZoomRange.addEventListener('input', function(){ if (!cropper) return; const v = parseFloat(cropZoomRange.value); try{ cropper.zoomTo(v); }catch(e){} });
  zoomIn.addEventListener('click', function(){ if (!cropper) return; try{ cropper.zoom(0.1); cropZoomRange.value = Math.min(3, parseFloat(cropZoomRange.value) + 0.1); }catch(e){} });
  zoomOut.addEventListener('click', function(){ if (!cropper) return; try{ cropper.zoom(-0.1); cropZoomRange.value = Math.max(1, parseFloat(cropZoomRange.value) - 0.1); }catch(e){} });

  cropApply.addEventListener('click', async function(){
    if (!cropper) return;
    try{
      const naturalCanvas = cropper.getCroppedCanvas();
      if (!naturalCanvas) { alert('Gagal memproses gambar'); return; }
      if (naturalCanvas.width < 400 || naturalCanvas.height < 400) {
        alert('Foto terlalu kecil. Gunakan gambar minimal 400x400 piksel.');
        return;
      }
      const finalCanvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
      const blob = await new Promise((res)=> finalCanvas.toBlob(res, 'image/jpeg', 0.9));
      if (!blob) { alert('Gagal memproses gambar'); return; }

      const fd = new FormData();
      fd.append('avatar', blob, 'avatar.jpg');
      try{
        const resp = await fetch('/profile', { method: 'POST', body: fd, credentials: 'same-origin' });
        if (resp.redirected) { window.location = resp.url; return; }
        if (resp.ok) { window.location.reload(); return; }
        const txt = await resp.text(); alert('Gagal memperbarui foto. Coba lagi. ' + txt);
      }catch(err){ alert('Gagal memperbarui foto. Coba lagi.'); }
    }catch(err){ alert('Gagal memproses gambar: ' + (err && err.message)); }
  });

  const editForm = document.getElementById('editForm');
  editForm.addEventListener('submit', async function(ev){ ev.preventDefault();
    const usernameVal = usernameInput.value.trim();
    if (!usernameRegex.test(usernameVal)){ showUsernameMessage('Username tidak valid', false); return; }
    const fd = new FormData();
    fd.append('username', usernameVal);
    fd.append('displayName', (document.querySelector('input[name="displayName"]').value || ''));
    fd.append('bio', (document.querySelector('textarea[name="bio"]').value || ''));
    fd.append('location', (document.querySelector('input[name="location"]').value || ''));
    const file = avatarInput.files && avatarInput.files[0];
    if (file && avatarPreview.tagName === 'IMG'){
      const size = 400; const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size; const ctx = canvas.getContext('2d');
      const img = document.createElement('img'); img.src = avatarPreview.src;
      await new Promise((r)=>{ img.onload=r; });
      const sw = img.naturalWidth * imgState.scale; const sh = img.naturalHeight * imgState.scale;
      const dx = imgState.sx; const dy = imgState.sy;
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,size,size);
      ctx.drawImage(img, -dx, -dy, img.naturalWidth*imgState.scale, img.naturalHeight*imgState.scale);
      const blob = await new Promise((res)=> canvas.toBlob(res, 'image/jpeg', 0.9));
      fd.append('avatar', blob, file.name || 'avatar.jpg');
    } else if (file){ fd.append('avatar', file); }

    try{
      const resp = await fetch('/profile', { method:'POST', body: fd, credentials:'same-origin' });
      if (resp.redirected) { window.location = resp.url; return; }
      if (resp.ok){ window.location.reload(); return; }
      const txt = await resp.text(); alert('Gagal menyimpan profil: ' + txt);
    }catch(err){ alert('Gagal menyimpan profil: ' + (err && err.message)); }
  });
</script>